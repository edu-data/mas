name: GAIM Lab Frontend Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Nightly build: ë§¤ì¼ ë°¤ 2ì‹œ (KST) = 17:00 UTC
    - cron: '0 17 * * *'

env:
  CI: true

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Fast Track: PR ìƒì„± ì‹œ ì‹¤í–‰ (< 3ë¶„ ëª©í‘œ)
  # Unit Test + Mocked E2E + Visual Regression
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  fast-test:
    name: ğŸš€ Fast Track (Mocked E2E)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      # 1. Unit Tests (Vitest)
      - name: Run Unit Tests
        run: npm run test -- --run --reporter=verbose

      # 2. Mocked E2E Tests (Playwright)
      - name: Run Mocked E2E Tests
        run: npx playwright test --project=mocked

      # 3. Visual Regression Tests
      - name: Run Visual Regression Tests
        run: npx playwright test --project=visual
        continue-on-error: true  # ì²« ì‹¤í–‰ ì‹œ ë² ì´ìŠ¤ë¼ì¸ ì—†ì„ ìˆ˜ ìˆìŒ

      # 4. Upload test artifacts
      - name: Upload Playwright Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-fast
          path: frontend/playwright-report/
          retention-days: 7

      - name: Upload Visual Snapshots
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: visual-diff-snapshots
          path: frontend/e2e/visual/__snapshots__/
          retention-days: 7

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Slow Track: Nightly ë¹Œë“œ ì‹œì—ë§Œ ì‹¤í–‰ (> 20ë¶„)
  # ì‹¤ì œ ì„œë²„ ì—°ë™ E2E í…ŒìŠ¤íŠ¸
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  nightly-test:
    name: ğŸŒ™ Slow Track (Real E2E)
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    defaults:
      run:
        working-directory: frontend

    services:
      # ë°±ì—”ë“œ ì„œë²„ (Docker)
      backend:
        image: gaim-lab-backend:latest
        ports:
          - 8000:8000
        options: >-
          --health-cmd "curl -f http://localhost:8000/health || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      REAL_API_URL: http://localhost:8000

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      # ëŒ€ìš©ëŸ‰ í…ŒìŠ¤íŠ¸ ì˜ìƒ ë‹¤ìš´ë¡œë“œ
      - name: Download test video
        run: |
          mkdir -p tests/fixtures
          curl -L -o tests/fixtures/real-lecture.mp4 \
            "${{ secrets.TEST_VIDEO_URL }}" || echo "Using local fixture"

      # Real E2E Tests (ì‹¤ì œ ì„œë²„ ì—°ë™)
      - name: Run Real E2E Tests
        run: npx playwright test --project=real
        timeout-minutes: 30

      - name: Upload Playwright Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-nightly
          path: frontend/playwright-report/
          retention-days: 14

      # Slack ì•Œë¦¼ (ì„ íƒì‚¬í•­)
      - name: Notify on failure
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#gaim-lab-alerts'
          mention: 'channel'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Visual Baseline Update: ìˆ˜ë™ íŠ¸ë¦¬ê±°
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  update-baselines:
    name: ğŸ“¸ Update Visual Baselines
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    defaults:
      run:
        working-directory: frontend

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Update snapshots
        run: npx playwright test --project=visual --update-snapshots

      - name: Commit updated baselines
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add e2e/visual/__snapshots__/
          git commit -m "chore: update visual baselines [skip ci]" || echo "No changes"
          git push
