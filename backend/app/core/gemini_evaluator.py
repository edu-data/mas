"""
ğŸ¤– Gemini Lecture Evaluator - LLM ê¸°ë°˜ ìˆ˜ì—… í‰ê°€ ëª¨ë“ˆ
Google Gemini APIë¥¼ í™œìš©í•œ 7ì°¨ì› ìˆ˜ì—… ì‹œì—° í‰ê°€

ì´ˆë“± ì„ìš© 2ì°¨ ìˆ˜ì—…ì‹¤ì—° í‰ê°€ ê¸°ì¤€ ê¸°ë°˜
"""

import os
import json
from typing import Dict, Optional
import google.generativeai as genai


# Gemini API ì„¤ì •
GOOGLE_API_KEY = os.environ.get("GOOGLE_API_KEY", "")
if GOOGLE_API_KEY:
    genai.configure(api_key=GOOGLE_API_KEY)


# 7ì°¨ì› í‰ê°€ í”„ë¡¬í”„íŠ¸
EVALUATION_PROMPT = """
ë‹¹ì‹ ì€ ì´ˆë“±í•™êµ êµì‚¬ ì„ìš© 2ì°¨ ìˆ˜ì—…ì‹¤ì—° í‰ê°€ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
ë‹¤ìŒ ìˆ˜ì—… ì‹œì—° í…ìŠ¤íŠ¸ë¥¼ ë¶„ì„í•˜ì—¬ 7ì°¨ì›ìœ¼ë¡œ í‰ê°€í•´ì£¼ì„¸ìš”.

[ìˆ˜ì—… í…ìŠ¤íŠ¸]
{transcript}

[í‰ê°€ ê¸°ì¤€]
1. ìˆ˜ì—… ì „ë¬¸ì„± (20ì  ë§Œì )
   - í•™ìŠµëª©í‘œ ëª…ë£Œì„±: í•™ìŠµ ëª©í‘œê°€ ëª…í™•í•˜ê²Œ ì œì‹œë˜ì—ˆëŠ”ê°€
   - í•™ìŠµë‚´ìš© ì¶©ì‹¤ì„±: êµìœ¡ê³¼ì •ì— ë§ëŠ” ë‚´ìš©ì„ ì¶©ì‹¤íˆ ë‹¤ë£¨ì—ˆëŠ”ê°€

2. êµìˆ˜í•™ìŠµ ë°©ë²• (20ì  ë§Œì )
   - êµìˆ˜ë²• ë‹¤ì–‘ì„±: ë‹¤ì–‘í•œ êµìˆ˜ ë°©ë²•ì„ í™œìš©í•˜ëŠ”ê°€
   - í•™ìŠµí™œë™ íš¨ê³¼ì„±: í•™ìŠµ í™œë™ì´ ëª©í‘œ ë‹¬ì„±ì— íš¨ê³¼ì ì¸ê°€

3. íŒì„œ ë° ì–¸ì–´ (15ì  ë§Œì )
   - íŒì„œ ê°€ë…ì„±: í•µì‹¬ ë‚´ìš©ì„ ëª…ë£Œí•˜ê²Œ ì •ë¦¬í•˜ëŠ”ê°€
   - ì–¸ì–´ ëª…ë£Œì„±: ë°œí™”ê°€ ì •í™•í•˜ê³  ëª…ë£Œí•œê°€
   - ë°œí™”ì†ë„ ì ì ˆì„±: í•™ìŠµì ìˆ˜ì¤€ì— ë§ëŠ” ì†ë„ì¸ê°€

4. ìˆ˜ì—… íƒœë„ (15ì  ë§Œì )
   - êµì‚¬ ì—´ì •: ìˆ˜ì—…ì— ëŒ€í•œ ì—´ì •ì´ ëŠê»´ì§€ëŠ”ê°€
   - í•™ìƒ ì†Œí†µ: í•™ìƒê³¼ì˜ ìƒí˜¸ì‘ìš©ì´ ìì—°ìŠ¤ëŸ¬ìš´ê°€
   - ìì‹ ê°: ìì‹ ê° ìˆëŠ” íƒœë„ë¡œ ìˆ˜ì—…í•˜ëŠ”ê°€

5. í•™ìƒ ì°¸ì—¬ (15ì  ë§Œì )
   - ì§ˆë¬¸ ê¸°ë²•: íš¨ê³¼ì ì¸ ë°œë¬¸ì„ ì‚¬ìš©í•˜ëŠ”ê°€
   - í”¼ë“œë°± ì œê³µ: í•™ìƒ ë°˜ì‘ì— ì ì ˆíˆ í”¼ë“œë°±í•˜ëŠ”ê°€

6. ì‹œê°„ ë°°ë¶„ (10ì  ë§Œì )
   - ì‹œê°„ ê· í˜•: ë„ì…-ì „ê°œ-ì •ë¦¬ê°€ ê· í˜• ìˆê²Œ ë°°ë¶„ë˜ì—ˆëŠ”ê°€

7. ì°½ì˜ì„± (5ì  ë§Œì )
   - ìˆ˜ì—… ì°½ì˜ì„±: ë…ì°½ì ì¸ ì•„ì´ë””ì–´ì™€ êµìˆ˜ ê¸°ë²•ì„ ì‚¬ìš©í•˜ëŠ”ê°€

[ì‘ë‹µ í˜•ì‹]
ë°˜ë“œì‹œ ì•„ë˜ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”. ë‹¤ë¥¸ í…ìŠ¤íŠ¸ëŠ” í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”.

{{
  "ìˆ˜ì—…_ì „ë¬¸ì„±": {{
    "ì ìˆ˜": 0-20 ì‚¬ì´ ì •ìˆ˜,
    "í•™ìŠµëª©í‘œ_ëª…ë£Œì„±": 0-10 ì‚¬ì´ ì •ìˆ˜,
    "í•™ìŠµë‚´ìš©_ì¶©ì‹¤ì„±": 0-10 ì‚¬ì´ ì •ìˆ˜,
    "ê·¼ê±°": "í‰ê°€ ê·¼ê±° ì„¤ëª…"
  }},
  "êµìˆ˜í•™ìŠµ_ë°©ë²•": {{
    "ì ìˆ˜": 0-20 ì‚¬ì´ ì •ìˆ˜,
    "êµìˆ˜ë²•_ë‹¤ì–‘ì„±": 0-10 ì‚¬ì´ ì •ìˆ˜,
    "í•™ìŠµí™œë™_íš¨ê³¼ì„±": 0-10 ì‚¬ì´ ì •ìˆ˜,
    "ê·¼ê±°": "í‰ê°€ ê·¼ê±° ì„¤ëª…"
  }},
  "íŒì„œ_ë°_ì–¸ì–´": {{
    "ì ìˆ˜": 0-15 ì‚¬ì´ ì •ìˆ˜,
    "íŒì„œ_ê°€ë…ì„±": 0-5 ì‚¬ì´ ì •ìˆ˜,
    "ì–¸ì–´_ëª…ë£Œì„±": 0-5 ì‚¬ì´ ì •ìˆ˜,
    "ë°œí™”ì†ë„_ì ì ˆì„±": 0-5 ì‚¬ì´ ì •ìˆ˜,
    "ê·¼ê±°": "í‰ê°€ ê·¼ê±° ì„¤ëª…"
  }},
  "ìˆ˜ì—…_íƒœë„": {{
    "ì ìˆ˜": 0-15 ì‚¬ì´ ì •ìˆ˜,
    "êµì‚¬_ì—´ì •": 0-5 ì‚¬ì´ ì •ìˆ˜,
    "í•™ìƒ_ì†Œí†µ": 0-5 ì‚¬ì´ ì •ìˆ˜,
    "ìì‹ ê°": 0-5 ì‚¬ì´ ì •ìˆ˜,
    "ê·¼ê±°": "í‰ê°€ ê·¼ê±° ì„¤ëª…"
  }},
  "í•™ìƒ_ì°¸ì—¬": {{
    "ì ìˆ˜": 0-15 ì‚¬ì´ ì •ìˆ˜,
    "ì§ˆë¬¸_ê¸°ë²•": 0-7 ì‚¬ì´ ì •ìˆ˜,
    "í”¼ë“œë°±_ì œê³µ": 0-8 ì‚¬ì´ ì •ìˆ˜,
    "ê·¼ê±°": "í‰ê°€ ê·¼ê±° ì„¤ëª…"
  }},
  "ì‹œê°„_ë°°ë¶„": {{
    "ì ìˆ˜": 0-10 ì‚¬ì´ ì •ìˆ˜,
    "ì‹œê°„_ê· í˜•": 0-10 ì‚¬ì´ ì •ìˆ˜,
    "ê·¼ê±°": "í‰ê°€ ê·¼ê±° ì„¤ëª…"
  }},
  "ì°½ì˜ì„±": {{
    "ì ìˆ˜": 0-5 ì‚¬ì´ ì •ìˆ˜,
    "ìˆ˜ì—…_ì°½ì˜ì„±": 0-5 ì‚¬ì´ ì •ìˆ˜,
    "ê·¼ê±°": "í‰ê°€ ê·¼ê±° ì„¤ëª…"
  }},
  "ì´ì ": 0-100 ì‚¬ì´ ì •ìˆ˜,
  "ì¢…í•©_í‰ê°€": "ì „ë°˜ì ì¸ ìˆ˜ì—… ì‹œì—°ì— ëŒ€í•œ ì¢…í•© í‰ê°€",
  "ê°•ì ": ["ê°•ì  1", "ê°•ì  2"],
  "ê°œì„ ì ": ["ê°œì„ ì  1", "ê°œì„ ì  2"]
}}
"""


class GeminiLectureEvaluator:
    """Gemini LLM ê¸°ë°˜ ìˆ˜ì—… ì‹œì—° í‰ê°€ê¸°"""
    
    def __init__(self, model_name: str = "gemini-2.0-flash"):
        """
        Args:
            model_name: ì‚¬ìš©í•  Gemini ëª¨ë¸ (ê¸°ë³¸: gemini-2.0-flash)
        """
        self.model_name = model_name
        self.model = None
        
        if GOOGLE_API_KEY:
            try:
                self.model = genai.GenerativeModel(model_name)
                print(f"âœ… Gemini ëª¨ë¸ ì´ˆê¸°í™”: {model_name}")
            except Exception as e:
                print(f"âŒ Gemini ëª¨ë¸ ì´ˆê¸°í™” ì‹¤íŒ¨: {e}")
    
    def evaluate_transcript(self, transcript: str) -> Optional[Dict]:
        """
        ìˆ˜ì—… í…ìŠ¤íŠ¸ë¥¼ Geminië¡œ í‰ê°€
        
        Args:
            transcript: Whisper STTë¡œ ì¶”ì¶œí•œ ìˆ˜ì—… í…ìŠ¤íŠ¸
            
        Returns:
            7ì°¨ì› í‰ê°€ ê²°ê³¼ ë”•ì…”ë„ˆë¦¬ (ì‹¤íŒ¨ ì‹œ None)
        """
        if not self.model:
            print("âŒ Gemini ëª¨ë¸ì´ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
            return None
        
        if not transcript or len(transcript.strip()) < 50:
            print("âŒ í‰ê°€í•  í…ìŠ¤íŠ¸ê°€ ë„ˆë¬´ ì§§ìŠµë‹ˆë‹¤.")
            return None
        
        # í”„ë¡¬í”„íŠ¸ ìƒì„±
        prompt = EVALUATION_PROMPT.format(transcript=transcript[:8000])  # í† í° ì œí•œ
        
        try:
            print("ğŸ¤– Gemini í‰ê°€ ì¤‘...")
            response = self.model.generate_content(prompt)
            
            # JSON íŒŒì‹±
            result_text = response.text.strip()
            
            # JSON ë¸”ë¡ ì¶”ì¶œ (```json ... ``` í˜•ì‹ ì²˜ë¦¬)
            if "```json" in result_text:
                result_text = result_text.split("```json")[1].split("```")[0]
            elif "```" in result_text:
                result_text = result_text.split("```")[1].split("```")[0]
            
            result = json.loads(result_text)
            
            print(f"âœ… Gemini í‰ê°€ ì™„ë£Œ: ì´ì  {result.get('ì´ì ', 0)}ì ")
            
            return result
            
        except json.JSONDecodeError as e:
            print(f"âŒ JSON íŒŒì‹± ì˜¤ë¥˜: {e}")
            print(f"   ì‘ë‹µ: {response.text[:500]}...")
            return None
        except Exception as e:
            print(f"âŒ Gemini API ì˜¤ë¥˜: {e}")
            return None
    
    def get_dimension_scores(self, gemini_result: Dict) -> Dict:
        """
        Gemini í‰ê°€ ê²°ê³¼ë¥¼ evaluator.py í˜•ì‹ìœ¼ë¡œ ë³€í™˜
        
        Args:
            gemini_result: evaluate_transcript ê²°ê³¼
            
        Returns:
            evaluator.pyì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” í˜•ì‹ì˜ ë”•ì…”ë„ˆë¦¬
        """
        if not gemini_result:
            return {}
        
        return {
            "professionalism": {
                "score": gemini_result.get("ìˆ˜ì—…_ì „ë¬¸ì„±", {}).get("ì ìˆ˜", 0),
                "criteria": {
                    "í•™ìŠµëª©í‘œ_ëª…ë£Œì„±": gemini_result.get("ìˆ˜ì—…_ì „ë¬¸ì„±", {}).get("í•™ìŠµëª©í‘œ_ëª…ë£Œì„±", 0),
                    "í•™ìŠµë‚´ìš©_ì¶©ì‹¤ì„±": gemini_result.get("ìˆ˜ì—…_ì „ë¬¸ì„±", {}).get("í•™ìŠµë‚´ìš©_ì¶©ì‹¤ì„±", 0)
                },
                "feedback": gemini_result.get("ìˆ˜ì—…_ì „ë¬¸ì„±", {}).get("ê·¼ê±°", "")
            },
            "teaching_method": {
                "score": gemini_result.get("êµìˆ˜í•™ìŠµ_ë°©ë²•", {}).get("ì ìˆ˜", 0),
                "criteria": {
                    "êµìˆ˜ë²•_ë‹¤ì–‘ì„±": gemini_result.get("êµìˆ˜í•™ìŠµ_ë°©ë²•", {}).get("êµìˆ˜ë²•_ë‹¤ì–‘ì„±", 0),
                    "í•™ìŠµí™œë™_íš¨ê³¼ì„±": gemini_result.get("êµìˆ˜í•™ìŠµ_ë°©ë²•", {}).get("í•™ìŠµí™œë™_íš¨ê³¼ì„±", 0)
                },
                "feedback": gemini_result.get("êµìˆ˜í•™ìŠµ_ë°©ë²•", {}).get("ê·¼ê±°", "")
            },
            "language": {
                "score": gemini_result.get("íŒì„œ_ë°_ì–¸ì–´", {}).get("ì ìˆ˜", 0),
                "criteria": {
                    "íŒì„œ_ê°€ë…ì„±": gemini_result.get("íŒì„œ_ë°_ì–¸ì–´", {}).get("íŒì„œ_ê°€ë…ì„±", 0),
                    "ì–¸ì–´_ëª…ë£Œì„±": gemini_result.get("íŒì„œ_ë°_ì–¸ì–´", {}).get("ì–¸ì–´_ëª…ë£Œì„±", 0),
                    "ë°œí™”ì†ë„_ì ì ˆì„±": gemini_result.get("íŒì„œ_ë°_ì–¸ì–´", {}).get("ë°œí™”ì†ë„_ì ì ˆì„±", 0)
                },
                "feedback": gemini_result.get("íŒì„œ_ë°_ì–¸ì–´", {}).get("ê·¼ê±°", "")
            },
            "attitude": {
                "score": gemini_result.get("ìˆ˜ì—…_íƒœë„", {}).get("ì ìˆ˜", 0),
                "criteria": {
                    "êµì‚¬_ì—´ì •": gemini_result.get("ìˆ˜ì—…_íƒœë„", {}).get("êµì‚¬_ì—´ì •", 0),
                    "í•™ìƒ_ì†Œí†µ": gemini_result.get("ìˆ˜ì—…_íƒœë„", {}).get("í•™ìƒ_ì†Œí†µ", 0),
                    "ìì‹ ê°": gemini_result.get("ìˆ˜ì—…_íƒœë„", {}).get("ìì‹ ê°", 0)
                },
                "feedback": gemini_result.get("ìˆ˜ì—…_íƒœë„", {}).get("ê·¼ê±°", "")
            },
            "participation": {
                "score": gemini_result.get("í•™ìƒ_ì°¸ì—¬", {}).get("ì ìˆ˜", 0),
                "criteria": {
                    "ì§ˆë¬¸_ê¸°ë²•": gemini_result.get("í•™ìƒ_ì°¸ì—¬", {}).get("ì§ˆë¬¸_ê¸°ë²•", 0),
                    "í”¼ë“œë°±_ì œê³µ": gemini_result.get("í•™ìƒ_ì°¸ì—¬", {}).get("í”¼ë“œë°±_ì œê³µ", 0)
                },
                "feedback": gemini_result.get("í•™ìƒ_ì°¸ì—¬", {}).get("ê·¼ê±°", "")
            },
            "time_management": {
                "score": gemini_result.get("ì‹œê°„_ë°°ë¶„", {}).get("ì ìˆ˜", 0),
                "criteria": {
                    "ì‹œê°„_ê· í˜•": gemini_result.get("ì‹œê°„_ë°°ë¶„", {}).get("ì‹œê°„_ê· í˜•", 0)
                },
                "feedback": gemini_result.get("ì‹œê°„_ë°°ë¶„", {}).get("ê·¼ê±°", "")
            },
            "creativity": {
                "score": gemini_result.get("ì°½ì˜ì„±", {}).get("ì ìˆ˜", 0),
                "criteria": {
                    "ìˆ˜ì—…_ì°½ì˜ì„±": gemini_result.get("ì°½ì˜ì„±", {}).get("ìˆ˜ì—…_ì°½ì˜ì„±", 0)
                },
                "feedback": gemini_result.get("ì°½ì˜ì„±", {}).get("ê·¼ê±°", "")
            },
            "total_score": gemini_result.get("ì´ì ", 0),
            "overall_feedback": gemini_result.get("ì¢…í•©_í‰ê°€", ""),
            "strengths": gemini_result.get("ê°•ì ", []),
            "improvements": gemini_result.get("ê°œì„ ì ", [])
        }


# CLI í…ŒìŠ¤íŠ¸
if __name__ == "__main__":
    import sys
    
    # í…ŒìŠ¤íŠ¸ í…ìŠ¤íŠ¸
    test_transcript = """
    ì—¬ëŸ¬ë¶„, ì•ˆë…•í•˜ì„¸ìš”. ì˜¤ëŠ˜ ìˆ˜ì—…ì„ ì‹œì‘í•˜ê² ìŠµë‹ˆë‹¤.
    ì˜¤ëŠ˜ì˜ í•™ìŠµ ëª©í‘œëŠ” ë¶„ìˆ˜ì˜ ë§ì…ˆì„ ì´í•´í•˜ê³  ê³„ì‚°í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.
    ì, ë¨¼ì € ë¶„ìˆ˜ë€ ë¬´ì—‡ì¼ê¹Œìš”? ë¶„ìˆ˜ëŠ” ì „ì²´ë¥¼ ë˜‘ê°™ì´ ë‚˜ëˆˆ ê²ƒ ì¤‘ì˜ ì¼ë¶€ë¥¼ ë‚˜íƒ€ë‚´ëŠ” ìˆ˜ì…ë‹ˆë‹¤.
    ì˜ˆë¥¼ ë“¤ì–´, í”¼ì í•œ íŒì„ 4ì¡°ê°ìœ¼ë¡œ ë‚˜ëˆ´ì„ ë•Œ í•œ ì¡°ê°ì€ 4ë¶„ì˜ 1ì´ ë©ë‹ˆë‹¤.
    ì, ì—¬ëŸ¬ë¶„ ìƒê°í•´ë³´ì„¸ìš”. 4ë¶„ì˜ 1ì— 4ë¶„ì˜ 1ì„ ë”í•˜ë©´ ì–¼ë§ˆê°€ ë ê¹Œìš”?
    ë§ì•„ìš”! 4ë¶„ì˜ 2, ì¦‰ 2ë¶„ì˜ 1ì´ ë©ë‹ˆë‹¤. ì•„ì£¼ ì˜í–ˆì–´ìš”!
    ì´ë ‡ê²Œ ë¶„ëª¨ê°€ ê°™ì€ ë¶„ìˆ˜ë¼ë¦¬ëŠ” ë¶„ìë§Œ ë”í•˜ë©´ ë©ë‹ˆë‹¤.
    ì¤‘ìš”í•œ ì ì€ ë¶„ëª¨ëŠ” ê·¸ëŒ€ë¡œ ë‘ê³  ë¶„ìë§Œ ë”í•œë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤.
    ì, ì´ì œ ì—°ìŠµ ë¬¸ì œë¥¼ í•¨ê»˜ í’€ì–´ë³¼ê¹Œìš”?
    ì˜¤ëŠ˜ ë°°ìš´ ë‚´ìš©ì„ ì •ë¦¬í•˜ë©´, ë¶„ëª¨ê°€ ê°™ì€ ë¶„ìˆ˜ì˜ ë§ì…ˆì€ ë¶„ìë¼ë¦¬ ë”í•˜ë©´ ë©ë‹ˆë‹¤.
    ë‹¤ìŒ ì‹œê°„ì—ëŠ” ë¶„ëª¨ê°€ ë‹¤ë¥¸ ë¶„ìˆ˜ì˜ ë§ì…ˆì„ ë°°ìš°ê² ìŠµë‹ˆë‹¤. ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤!
    """
    
    if len(sys.argv) > 1:
        # íŒŒì¼ì—ì„œ í…ìŠ¤íŠ¸ ì½ê¸°
        with open(sys.argv[1], 'r', encoding='utf-8') as f:
            test_transcript = f.read()
    
    evaluator = GeminiLectureEvaluator()
    
    if evaluator.model:
        result = evaluator.evaluate_transcript(test_transcript)
        
        if result:
            print("\n" + "="*60)
            print("ğŸ“Š Gemini 7ì°¨ì› í‰ê°€ ê²°ê³¼")
            print("="*60)
            
            print(f"\nì´ì : {result.get('ì´ì ', 0)}ì  / 100ì ")
            print(f"\nì¢…í•© í‰ê°€:\n{result.get('ì¢…í•©_í‰ê°€', '')}")
            
            print("\nì°¨ì›ë³„ ì ìˆ˜:")
            for dim in ["ìˆ˜ì—…_ì „ë¬¸ì„±", "êµìˆ˜í•™ìŠµ_ë°©ë²•", "íŒì„œ_ë°_ì–¸ì–´", 
                       "ìˆ˜ì—…_íƒœë„", "í•™ìƒ_ì°¸ì—¬", "ì‹œê°„_ë°°ë¶„", "ì°½ì˜ì„±"]:
                if dim in result:
                    score = result[dim].get("ì ìˆ˜", 0)
                    print(f"  - {dim}: {score}ì ")
            
            print("\nê°•ì :")
            for s in result.get("ê°•ì ", []):
                print(f"  âœ… {s}")
            
            print("\nê°œì„ ì :")
            for i in result.get("ê°œì„ ì ", []):
                print(f"  ğŸ”§ {i}")
    else:
        print("GOOGLE_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
        print("export GOOGLE_API_KEY='your-api-key'")
